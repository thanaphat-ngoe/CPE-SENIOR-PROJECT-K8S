import time
from DecisionEngineV2 import DecisionEngine

def run_tests():
    print("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Decision Engine (Unit Testing)\n" + "="*50)
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏°‡∏≠‡∏á‡∏Å‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏õ‡∏Ñ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á)
    engine = DecisionEngine(cores_per_node=4.0, max_workers=2, min_workers=1)
    
    # ‡∏õ‡∏£‡∏±‡∏ö Threshold ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™)
    engine.scale_out_percent = 0.80
    engine.scale_in_percent = 0.95
    engine.safe_cpu_percent = 80.0
    
    # =======================================================
    # üß™ SCENARIO 1: ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Normal Load)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 1: ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏ä‡∏¥‡∏•‡πÜ (‡∏Ñ‡∏ß‡∏£ DO_NOTHING)")
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥: ‡∏°‡∏µ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (4 Cores), AI ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ 2.5 Cores
    action, reason = engine.decide(predicted_cores=2.5, current_workers=1, pending_pods=0, current_cpu_usage=40.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    # =======================================================
    # üß™ SCENARIO 2: ‡∏Ñ‡∏¥‡∏ß‡∏•‡πâ‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Pending Pods Emergency)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 2: ‡∏°‡∏µ Pod ‡∏Ñ‡πâ‡∏≤‡∏á (‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á SCALE_OUT ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏°‡πâ‡πÇ‡∏´‡∏•‡∏î AI ‡∏à‡∏∞‡∏ï‡πà‡∏≥)")
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥: ‡∏°‡∏µ Pending 3 pods
    action, reason = engine.decide(predicted_cores=1.0, current_workers=1, pending_pods=3, current_cpu_usage=50.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    # =======================================================
    # üß™ SCENARIO 3: ‡∏ï‡∏¥‡∏î Cooldown ‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (Scale-Out Cooldown)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 3: ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏õ‡∏´‡∏¢‡∏Å‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏∏‡πà‡∏á‡∏≠‡∏µ‡∏Å (‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á WAIT/DO_NOTHING)")
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥: ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏∏‡πà‡∏á‡πÑ‡∏õ 8.0 ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á Scale Out ‡πÑ‡∏õ‡∏à‡∏≤‡∏Å Test 2
    action, reason = engine.decide(predicted_cores=8.0, current_workers=1, pending_pods=0, current_cpu_usage=90.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    # --- ‡πÄ‡∏£‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô Cooldown ---
    engine.last_scale_out_time -= 9999 

    # =======================================================
    # üß™ SCENARIO 4: AI ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Predictive Scale-Out)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 4: ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏∏‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏ú‡πà‡∏≤‡∏ô Cooldown ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á SCALE_OUT)")
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥: ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ 3.5 (‡∏ó‡∏∞‡∏•‡∏∏ 80% ‡∏Ç‡∏≠‡∏á 4 Cores)
    action, reason = engine.decide(predicted_cores=3.5, current_workers=1, pending_pods=0, current_cpu_usage=85.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    # =======================================================
    # üß™ SCENARIO 5: ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏° (Max Workers Reached)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 5: ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏° Max = 2 ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏ß‡∏£ Blocked)")
    action, reason = engine.decide(predicted_cores=10.0, current_workers=2, pending_pods=0, current_cpu_usage=95.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    # --- ‡πÄ‡∏£‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô Cooldown ---
    engine.last_scale_out_time -= 9999 

    # =======================================================
    # üß™ SCENARIO 6: Guardrail ‡∏Ç‡∏≤‡∏•‡∏á (High CPU Usage Block)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 6: AI ‡∏™‡∏±‡πà‡∏á‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏ï‡πà CPU ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡∏ó‡∏∞‡∏•‡∏∏ 90% ‡∏≠‡∏¢‡∏π‡πà (‡∏Ñ‡∏ß‡∏£ Blocked Guardrail)")
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥: ‡∏°‡∏µ 2 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á AI ‡∏ó‡∏≤‡∏¢‡πÅ‡∏Ñ‡πà 1.0 (‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å) ‡πÅ‡∏ï‡πà CPU ‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á 90%
    action, reason = engine.decide(predicted_cores=1.0, current_workers=2, pending_pods=0, current_cpu_usage=90.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    # =======================================================
    # üß™ SCENARIO 7: AI ‡∏™‡∏±‡πà‡∏á‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Predictive Scale-In)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 7: ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πà‡∏≥ CPU‡∏ï‡πà‡∏≥ ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á SCALE_IN)")
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥: CPU ‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 30% ‡πÅ‡∏•‡πâ‡∏ß, AI ‡∏ó‡∏≤‡∏¢ 2.5 (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 95% ‡∏Ç‡∏≠‡∏á 4.0 Cores)
    action, reason = engine.decide(predicted_cores=2.5, current_workers=2, pending_pods=0, current_cpu_usage=30.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    # =======================================================
    # üß™ SCENARIO 8: ‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (Min Workers Reached)
    # =======================================================
    print("‚ñ∂Ô∏è TEST 8: ‡∏≠‡∏¢‡∏≤‡∏Å‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà Min = 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏ß‡∏£ Blocked)")
    # ‡∏™‡∏°‡∏°‡∏ï‡∏¥: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á AI ‡∏ó‡∏≤‡∏¢ 0.1
    action, reason = engine.decide(predicted_cores=0.1, current_workers=1, pending_pods=0, current_cpu_usage=5.0)
    print(f"‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ü§ñ: {action} | {reason}\n")

    print("="*50 + "\n‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç!")

if __name__ == "__main__":
    run_tests()